<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cdtu.mapper.PublishSignInMapper">
	<insert id="insert">
		INSERT publish_sign_in (ps_id, tsc_id, s_start_time, s_check_code)
		SELECT #{psId}, tsc_id, #{time}, #{checkCode}
		FROM teacher_select_course
		WHERE t_id = #{tId}
		AND c_id = #{cId}
	</insert>

	<update id="update">
		UPDATE publish_sign_in SET s_status = 0
		WHERE ps_id = #{psId}
	</update>

	<select id="selectTimeCodeStatus" resultType="java.util.HashMap">
		SELECT s_check_code AS checkCode, s_start_time AS startTime, s_status AS sStatus
		FROM publish_sign_in
		WHERE ps_id = #{psId}
	</select>

	<select id="count" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM publish_sign_in, teacher_select_course
		WHERE teacher_select_course.t_id = #{tId}
		AND teacher_select_course.c_id = #{cId}
		AND publish_sign_in.tsc_id = teacher_select_course.tsc_id
		AND s_start_time >= DATE_SUB(NOW(), INTERVAL 60 * 95 SECOND)
		LIMIT 1
	</select>

	<select id="selectByTIdAndCID" resultType="java.util.HashMap">
		SELECT student.s_id AS sId, s_img_src AS sImgSrc,
		s_name AS sName, ss_status AS ssStatus, ss_time AS ssTime
		FROM publish_sign_in, teacher_select_course, student_sign_in, student
		WHERE teacher_select_course.t_id = #{tId}
		AND teacher_select_course.c_id = #{cId}
		AND publish_sign_in.tsc_id = teacher_select_course.tsc_id
		AND s_start_time >= DATE_SUB(NOW(), INTERVAL 60 * 95 SECOND)
		AND student_sign_in.ps_id = publish_sign_in.ps_id
		AND student.s_id = student_sign_in.s_id
	</select>

	<select id="selectBySIdAndCId" resultType="java.util.HashMap">
		SELECT publish_sign_in.ps_id AS psId, publish_sign_in.s_status AS psStatus
		FROM student_select_course, teacher_select_course, publish_sign_in
		WHERE student_select_course.s_id = #{sId}
		AND teacher_select_course.c_id = #{cId}
		AND teacher_select_course.tsc_id = student_select_course.tsc_id
		AND publish_sign_in.tsc_id = teacher_select_course.tsc_id
		AND s_start_time >= DATE_SUB(NOW(), INTERVAL 60 * 95 SECOND)
	</select>
</mapper>